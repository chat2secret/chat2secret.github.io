<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>چت امنیتی</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        input, select, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        #chatBox {
            margin-top: 20px;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        #messages {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .message {
            padding: 8px 12px;
            border-radius: 4px;
            max-width: 70%;
        }
        .message.self {
            align-self: flex-end;
            background-color: #3498db;
            color: white;
        }
        .message.other {
            align-self: flex-start;
            background-color: #ecf0f1;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>چت امنیتی</h1>
        
        <form id="joinForm">
            <input type="text" id="groupKey" placeholder="کلید گروه" required>
            <button type="submit">ورود به گروه</button>
        </form>

        <div id="roleSelection" class="hidden">
            <h2>نقش خود را انتخاب کنید</h2>
            <select id="roleSelect"></select>
            <button id="startChat">شروع چت</button>
        </div>

        <div id="chatBox" class="hidden">
            <h2>چت (<span id="currentRole"></span>)</h2>
            <div id="messages"></div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <input type="text" id="messageInput" placeholder="پیام شما..." style="flex-grow: 1;">
                <button id="sendButton">ارسال</button>
            </div>
        </div>
    </div>

    <script>
        const groupKeyInput = document.getElementById("groupKey");
        const joinForm = document.getElementById("joinForm");
        const roleSelection = document.getElementById("roleSelection");
        const roleSelect = document.getElementById("roleSelect");
        const startChatBtn = document.getElementById("startChat");
        const chatBox = document.getElementById("chatBox");
        const messagesDiv = document.getElementById("messages");
        const messageInput = document.getElementById("messageInput");
        const sendButton = document.getElementById("sendButton");
        const currentRoleSpan = document.getElementById("currentRole");

        let socket;
        let userRole;

        joinForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const groupKey = groupKeyInput.value;
            const response = await fetch(`https://security-chat.liara.run/get_group_roles?group_key=${groupKey}`);
            if (response.ok) {
                const roles = await response.json();
                roleSelect.innerHTML = '';
                roles.forEach(role => {
                    const option = document.createElement("option");
                    option.value = role;
                    option.textContent = role;
                    roleSelect.appendChild(option);
                });
                joinForm.classList.add("hidden");
                roleSelection.classList.remove("hidden");
            } else {
                alert("گروه یافت نشد!");
            }
        });

        startChatBtn.addEventListener("click", () => {
            userRole = roleSelect.value;
            currentRoleSpan.textContent = userRole;
            roleSelection.classList.add("hidden");
            chatBox.classList.remove("hidden");

            socket = new WebSocket(`wss://security-chat.liara.run/ws/${groupKeyInput.value}/${userRole}`);
            socket.onmessage = (event) => {
                const message = document.createElement("div");
                message.textContent = event.data;
                message.classList.add("message", "other");
                messagesDiv.appendChild(message);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            };
        });

        function sendMessage() {
            const message = messageInput.value;
            if (message && socket) {
                const messageElement = document.createElement("div");
                messageElement.textContent = message;
                messageElement.classList.add("message", "self");
                messagesDiv.appendChild(messageElement);
                socket.send(message);
                messageInput.value = "";
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        sendButton.addEventListener("click", sendMessage);
        messageInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage();
        });
    </script>
</body>
</html>
